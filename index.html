<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Causal Looper</title>
    <link rel="icon" type="image/png" href="./favicon.png">
    <link rel="stylesheet" href="./css/main.css">
</head>
<body>
    <header>
        <h1>Causal Looper</h1>
        <navigation>
            <button id="downloadSvgBtn">ğŸ’¾SVG</button>
            <button id="downloadDotBtn">ğŸ’¾dot</button>
        </navigation>
    </header>
    <div class="container">
        <div class="input-area">
            <h2 id="inputTitle">DSLå…¥åŠ›</h2>
            <textarea id="dslInput" rows="25"></textarea>
            <br>
        </div>
        <div class="graph-area">
            <h2 id="graphTitle">ã‚°ãƒ©ãƒ•è¡¨ç¤º</h2>
            <div id="selectLoop"></div>
            <div id="graph" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script src="./js/d3.js"></script>
    <script type="module" src="./js/wasm.js"></script>
    <script src="./js/d3-graphviz.js"></script>
    <script src="./js/looper-translator.js"></script>

    <script>
        // è¨€èªè¨­å®š
        const isJapanese = navigator.language.startsWith('ja');
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
        const sampleTextJa = `// ç”£æ²¹å›½ã®ã‚¤ãƒ³ãƒ•ãƒ¬ã®æ‚ªå¾ªç’°

Loop:ã‚¤ãƒ³ãƒ•ãƒ¬ã®æ‚ªå¾ªç’°
ãƒãƒ©ãƒã‚­æ”¯å‡º -> è²¡æ”¿èµ¤å­— (+) : èµ¤å­—ã®æ‹¡å¤§
è²¡æ”¿èµ¤å­— -> é€šè²¨ç™ºè¡Œ (+) : ç´™å¹£ã®ä¹±ç™º
é€šè²¨ç™ºè¡Œ -> ã‚¤ãƒ³ãƒ•ãƒ¬ (+) delay : é€šè²¨ä¾¡å€¤ã®æš´è½
ã‚¤ãƒ³ãƒ•ãƒ¬ -> ãƒãƒ©ãƒã‚­æ”¯å‡º (+) : è£œå¡«é¡ã®å¢—åŠ 

Loop: ç”£æ¥­ç ´å£Šã®æ‚ªå¾ªç’°
ã‚¤ãƒ³ãƒ•ãƒ¬ -> ä¾¡æ ¼çµ±åˆ¶ (+) : ç„¡ç†ãªä¾¡æ ¼å›ºå®š
ä¾¡æ ¼çµ±åˆ¶ -> æ°‘é–“ä¼æ¥­ã®åˆ©ç›Š (-) : æ¡ç®—ã®æ‚ªåŒ–
æ°‘é–“ä¼æ¥­ã®åˆ©ç›Š -> å›½å†…ç”Ÿç”£åŠ› (+) delay : å€’ç”£ãƒ»æ’¤é€€
å›½å†…ç”Ÿç”£åŠ› -> ãƒ¢ãƒä¸è¶³ (-) : ä¾›çµ¦ã®åœæ­¢
ãƒ¢ãƒä¸è¶³ -> ã‚¤ãƒ³ãƒ•ãƒ¬ (+) : å¸Œå°‘æ€§ã«ã‚ˆã‚‹é«˜é¨°

Loop: å¤–éƒ¨è¦å› ã¨ã‚ªãƒ©ãƒ³ãƒ€ç—…
åŸæ²¹ä¾¡æ ¼ -> çŸ³æ²¹åå…¥ (+) : å¤–è²¨ã®ç²å¾—
çŸ³æ²¹åå…¥ -> è²¡æ”¿èµ¤å­— (-) : èµ¤å­—ã®ç©´åŸ‹ã‚
çŸ³æ²¹åå…¥ -> å®‰ä¾¡ãªè¼¸å…¥å“ (+) : è¼¸å…¥ã®æ‹¡å¤§
å®‰ä¾¡ãªè¼¸å…¥å“ -> å›½å†…ç”Ÿç”£åŠ› (-) delay : å›½å†…ç”£æ¥­ã®é§†é€`;

        const sampleTextEn = `// Vicious Cycle of Inflation in Oil-Producing Countries

Loop: Inflation Vicious Cycle
Excessive Spending -> Fiscal Deficit (+) : Expanding deficit
Fiscal Deficit -> Currency Printing (+) : Printing money
Currency Printing -> Inflation (+) delay : Currency devaluation
Inflation -> Excessive Spending (+) : Increased compensation

Loop: Industrial Destruction Cycle
Inflation -> Price Control (+) : Forced price fixing
Price Control -> Private Enterprise Profit (-) : Worsening profitability
Private Enterprise Profit -> Domestic Production (+) delay : Bankruptcy and withdrawal
Domestic Production -> Goods Shortage (-) : Supply shutdown
Goods Shortage -> Inflation (+) : Price surge due to scarcity

Loop: External Factors and Dutch Disease
Oil Price -> Oil Revenue (+) : Foreign currency acquisition
Oil Revenue -> Fiscal Deficit (-) : Filling budget gaps
Oil Revenue -> Cheap Imports (+) : Expansion of imports
Cheap Imports -> Domestic Production (-) delay : Displacement of domestic industry`;

        // è¨€èªã«å¿œã˜ã¦ãƒ†ã‚­ã‚¹ãƒˆã¨UIã‚’è¨­å®š
        if (isJapanese) {
            document.getElementById('dslInput').value = sampleTextJa;
            document.getElementById('dslInput').placeholder = sampleTextJa;
            document.getElementById('inputTitle').textContent = 'DSLå…¥åŠ›';
            document.getElementById('graphTitle').textContent = 'ã‚°ãƒ©ãƒ•è¡¨ç¤º';
        } else {
            document.getElementById('dslInput').value = sampleTextEn;
            document.getElementById('dslInput').placeholder = sampleTextEn;
            document.getElementById('inputTitle').textContent = 'DSL Input';
            document.getElementById('graphTitle').textContent = 'Graph Display';
        }

        function addLoopCheckboxes(loopClasses) {
            const selectLoopDiv = document.getElementById('selectLoop');
            selectLoopDiv.innerHTML = ''; // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
            for (let index = 0; index < loopClasses.length; index++) {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    const edges = document.querySelectorAll(`.edge${index}`);
                    console.log(`.edge${index} selected:`);
                    console.log(edges);
                    edges.forEach(edge => {
                        edge.style.display = this.checked ? 'block' : 'none';
                    });
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(loopClasses[index]));
                selectLoopDiv.appendChild(label);
            }
        }

        function renderGraph() {
            const text = document.getElementById('dslInput').value;
            const clusters = parseDSL(text);
            const dotSource = generateDOT(clusters);
            const loopClasses = getLoopClasses();

            // å‰å›ã®loopClassesã¨æ¯”è¼ƒ
            if (!window.previousLoopClasses ||
                JSON.stringify(window.previousLoopClasses) !== JSON.stringify(loopClasses)) {
                addLoopCheckboxes(loopClasses);
                window.previousLoopClasses = [...loopClasses]; // ã‚³ãƒ”ãƒ¼ã‚’ä¿å­˜
            }

            try {
                d3.select("#graph")
                    .graphviz({
                        useWorker: false,
                        engine: 'dot',
                        zoom: false
                    })
                    .renderDot(dotSource);
            } catch (error) {
                console.error(error);
                document.getElementById("graph").innerText = "ã‚¨ãƒ©ãƒ¼: " + error.message;
            }
        }

        // SVGãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadSVG() {
            const svgElement = document.querySelector('#graph svg');
            if (!svgElement) {
                alert(isJapanese ? 'ã‚°ãƒ©ãƒ•ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“' : 'Graph not generated');
                return;
            }
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'causal-loop-diagram.svg';
            link.click();
            URL.revokeObjectURL(url);
        }

        // DOTãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadDOT() {
            const text = document.getElementById('dslInput').value;
            const clusters = parseDSL(text);
            const dotSource = generateDOT(clusters);
            const blob = new Blob([dotSource], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'causal-loop-diagram.dot';
            link.click();
            URL.revokeObjectURL(url);
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
        document.getElementById('downloadSvgBtn').addEventListener('click', downloadSVG);
        document.getElementById('downloadDotBtn').addEventListener('click', downloadDOT);

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å¤‰æ›´ã§è‡ªå‹•æç”»ï¼ˆdebounceä»˜ãï¼‰
        let debounceTimer;
        document.getElementById('dslInput').addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(renderGraph, 500); // 500mså¾…æ©Ÿå¾Œã«æç”»
        });
        // åˆå›æç”»
        renderGraph();
    </script>
</body>
</html>